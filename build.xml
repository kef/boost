<?xml version="1.0" encoding="UTF-8"?>

<!-- FIXME: SC502 Goals
   - Run tests
   - Checkstyle run
   - Checkstyle report (into artifacts area)
   - Checkstyle fail on error
   - Simian run
   - Simian report (into artifacts area)
   - Simian fail on error
   - Instrument classes (cobertura.sourceforge.net)
   - Run AtomicTests against instrumented classes
   - Atomic test coverage report (into artifacts area)
   - Fail on < 100% atomic test coverage
   - Run "other" tests against raw classes
   - Generate javadoc (if you're doing this)
   - Package up jars or whatever (using non instrumented classes)
  -->

<!-- FIXME: SC502 Refactor
   - Move junit.classpath out of compileTest target
   - Allow CruiseControl to set the parent directory for ${junit.dir}
   - Check environment properties (fail if not correctly set)
   - ? "compileAll" target
   - ? Different prefixes for dependency targets
   - Include profile (properties).  One property should specify a
       properties file somewhere, usually under <project>/conf/profile
  -->

<project name="boost" default="all" basedir=".">
	<property name="build.dir" location="build" />
	<property name="build.classes.dir" location="${build.dir}/classes" />
	<property name="build.jars.dir" location="${build.dir}/jars" />
	<property name="lib.dir" location="lib" />

	<!-- CruiseControl uses ${junit.dir}.  Change with care ! -->
	<property name="junit.dir" value="${build.dir}/junit-results" />
	<property name="test.class" value="au.net.netstorm.boost.testing.suite.AllTestSuite" />

	<target
		name="all" depends="clean,compile,compileTest,runTest,createJar">
	</target>

	<target name="clean" description="Clean all build files">
		<!-- Assume that *all* things are created under ${build.dir} -->
		<delete dir="${build.dir}" />
	</target>

	<!-- FIXME: SC502 Consider the naming of "prod" and "edge" -->

	<target name="compile" description="Build edge and prod code">
		<mkdir dir="${build.classes.dir}" />
		<javac srcdir="src/edge/java" destdir="${build.classes.dir}" />
		<javac srcdir="src/prod/java" destdir="${build.classes.dir}" />
	</target>

	<target name="compileTest" description="Build test code">
		<path id="junit.classpath">
			<fileset dir="${lib.dir}">
				<include name="junit/junit-3.8.1.jar" />
			</fileset>
		</path>
		<javac srcdir="src/test/java" destdir="${build.classes.dir}">
			<classpath refid="junit.classpath" />
		</javac>
	</target>
	
	<target name="runTest" description="Run JUnit tests">
		<mkdir dir="${junit.dir}" />
		<path id="test.classpath">
			<pathelement location="${build.classes.dir}" />
			<fileset dir="${lib.dir}">
				<include name="junit/junit-3.8.1.jar" />
			</fileset>
		</path>
		<junit fork="yes" errorProperty="test.failed" failureProperty="test.failed">
			<test name="${test.class}" todir="${junit.dir}" />
			<formatter type="brief" usefile="false" />
			<formatter type="xml" />
			<jvmarg value="-Dtest.classpath=${build.classes.dir}"/>
			<classpath refid="test.classpath" />
		</junit>
	</target>

	<target name="createJar" description="Create jar" >
		<mkdir dir="${build.jars.dir}" />
		<jar
			jarfile="${build.jars.dir}/boost.jar"
			basedir="${build.classes.dir}">
		</jar>
	</target>
</project>