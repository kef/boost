<?xml version="1.0" encoding="UTF-8"?>

<!--Targets either do stuff or specify dependencies; never both. -->
<!--Dependency targets begin with "_". -->

<!-- FIXME: SC502 Goals: -->
<!-- FIXME: SC502 Checkstyle run -->
<!-- FIXME: SC502 Checkstyle report (into artifacts area) -->
<!-- FIXME: SC502 Checkstyle fail on error -->
<!-- FIXME: SC502 Simian run -->
<!-- FIXME: SC502 Simian report (into artifacts area) -->
<!-- FIXME: SC502 Simian fail on error -->
<!-- FIXME: SC502 Instrument classes (cobertura.sourceforge.net) -->
<!-- FIXME: SC502 Run AtomicTests against instrumented classes -->
<!-- FIXME: SC502 Atomic test coverage report (into artifacts area) -->
<!-- FIXME: SC502 Fail on < 100% atomic test coverage -->
<!-- FIXME: SC502 Run "other" tests against raw classes -->
<!-- FIXME: SC502 Generate javadoc (if you're doing this) -->
<!-- FIXME: SC502 Package up jars or whatever (using non instrumented classes) -->

<!-- FIXME: SC502 Refactors: -->
<!-- FIXME: SC502 Check environment properties (fail if not correctly set) -->
<!-- FIXME: SC502 Include profile (properties).  One property should specify a properties file somewhere, usually under <project>/conf/profile -->

<project name="boost" default="_all" basedir=".">
    <property name="build.dir" location="build"/>
    <property name="lib.dir" location="lib"/>
    <property name="src.dir" value="src"/>
    <property name="class.dir" location="${build.dir}/classes"/>
    <property name="artifacts.dir" location="${build.dir}/artifacts"/>
    <property name="reports.dir" location="${artifacts.dir}/reports"/>
    <property name="jars.dir" location="${artifacts.dir}/jars"/>
    <property name="test.report.dir" location="${reports.dir}/test"/>
    <property name="test.xml.report.dir" location="${test.report.dir}/xml"/>
    <property name="test.class" value="au.net.netstorm.boost.testing.suite.AtomicTestSuite"/>

    <path id="test.lib.classpath">
        <pathelement location="${class.dir}"/>
        <fileset dir="${lib.dir}">
            <include name="junit/junit-3.8.1.jar"/>
        </fileset>
    </path>

    <property name="edge.src.dir" location="${src.dir}/edge/java"/>
    <property name="core.src.dir" location="${src.dir}/core/java"/>
    <property name="test.src.dir" location="${src.dir}/test/java"/>
    <property name="edge.class.dir" location="${class.dir}/edge"/>
    <property name="core.class.dir" location="${class.dir}/core"/>
    <property name="test.class.dir" location="${class.dir}/test"/>

    <fileset id="atomic.tests" dir="${test.src.dir}">
        <include name="**/*AtomicTest.java"/>
    </fileset>
    <path id="atomic.tests.classpath">
        <path location="${test.class.dir}"/>
        <path location="${core.class.dir}"/>
        <path location="${edge.class.dir}"/>
    </path>

    <path id="edge.classpath"/>
    <path id="core.classpath">
        <path location="${edge.class.dir}"/>
    </path>
    <path id="test.classpath">
        <path refid="core.classpath"/>
        <path location="${core.class.dir}"/>
    </path>

    <!-- FIXME: SC502 Put "check_tests" target back in ... when it no longer breaks the build ! -->
    <!-- FIXME: SC502 Put jar target back in with modified classpaths -->
    <target name="_all" depends="clean,_compile,_run_tests,report_tests,_check_tests"/>

    <target name="_compile">
        <macro_javac srcdir="${edge.src.dir}" destdir="${edge.class.dir}" classpathref="edge.classpath"/>
        <macro_javac srcdir="${core.src.dir}" destdir="${core.class.dir}" classpathref="core.classpath"/>
        <macro_javac srcdir="${test.src.dir}" destdir="${test.class.dir}" classpathref="test.classpath"/>
    </target>

    <target name="clean">
        <delete dir="${build.dir}"/>
    </target>

    <target name="build_jar">
        <mkdir dir="${jars.dir}"/>
        <jar jarfile="${jars.dir}/boost.jar" basedir="${class.dir}"/>
    </target>

    <!-- FIXME: SC502 "runTest" crashes when executed in Andy's Eclipse :( -->
    <!-- FIXME: SC502 Rename to run_atomic_tests when atomic tests are run. -->
    <target name="_run_tests">
        <macro_junit tests.refid="atomic.tests" classpath.refid="atomic.tests.classpath" failure.property="atomic.tests.failed"/>
    </target>
    <target name="_check_tests">
        <macro_junit_check failure.property="atomic.tests.failed"/>
    </target>

    <!-- FIXME: SC502 Move fileset out.  -->
    <!-- FIXME: SC502 Macroise. -->
    <!-- FIXME: SC502 Change failure property to be accurate. -->
    <target name="report_tests">
        <junitreport todir="${test.report.dir}" tofile="TestReport.xml">
            <fileset dir="${test.xml.report.dir}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${test.report.dir}"/>
        </junitreport>
    </target>

    <macrodef name="macro_javac">
        <attribute name="srcdir"/>
        <attribute name="destdir"/>
        <attribute name="classpathref"/>
        <sequential>
            <mkdir dir="@{destdir}"/>
            <javac srcdir="@{srcdir}" destdir="@{destdir}" classpathref="@{classpathref}" debug="true"/>
        </sequential>
    </macrodef>

    <!-- FIXME: SC502 Rename to junit_macro_run? -->
    <macrodef name="macro_junit">
        <attribute name="tests.refid"/>
        <attribute name="classpath.refid"/>
        <attribute name="failure.property"/>
        <sequential>
            <mkdir dir="${test.xml.report.dir}"/>
            <junit fork="true" forkmode="perBatch" showoutput="true" printSummary="true" haltonfailure="false"
                   failureproperty="@{failure.property}">
                <!-- FIXME: SC502 Reinstate for cobertura. -->
                <!--<sysproperty key="net.sourceforge.cobertura.datafile" file="${coverage.file}"/>-->
                <classpath refid="@{classpath.refid}"/>
                <formatter type="xml"/>
                <formatter type="plain"/>
                <batchtest todir="${test.xml.report.dir}">
                    <fileset refid="@{tests.refid}"/>
                </batchtest>
            </junit>
        </sequential>
    </macrodef>

    <macrodef name="macro_junit_check">
        <attribute name="failure.property"/>
        <sequential>
            <fail if="@{failure.property}" message="ONE OR MORE TESTS FAILED."/>
        </sequential>
    </macrodef>


</project>