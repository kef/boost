<?xml version="1.0" encoding="UTF-8"?>

<!-- FIXME: SC502 SPLIT INTO SEPARATE FILES BASED ON FUNCTIONALITY !!!!!!!!!!!!!!! -->
<!-- FIXME: Where is Andy's refactoring chocolate ? -->

<!-- FIXME: SC999 NEW FEATURES: Thread conversion to string (target exceptions, proxies...) -->
<!-- FIXME: SC999 NEW FEATURES: A top level thread executor. -->


<!-- FIXME: SC502 Create Kickstart IntelliJ project and module files for each pair. -->

<!-- FIXME: SC502 Goals: -->
<!-- FIXME: SC502 Run "other" tests against raw classes (integration, acceptance) -->
<!-- FIXME: SC502 Generate javadoc (if you're doing this) -->
<!-- FIXME: SC502 Move from JDK 1.5 back to JDK 1.4 compliance target -->
<!-- FIXME: SC502 Add script(s) to run build from the command line? JUnit needs to be in Ant classpath. -->
<!-- FIXME: SC502 Check environment properties (fail if not correctly set) -->
<!-- FIXME: SC502 Include profile (properties). One property should specify a properties file somewhere, usually under <project>/conf/profile -->

<!-- FIXME: SC502 Refactors: -->
<!-- FIXME: SC502 Order targets in file alphabetically or functionally or chronologically ... not randomly -->
<!-- FIXME: SC502 Break build up into separate files and use import to piece it back together. -->
<!-- FIXME: SC502 Get consistent about singular vs plural directory and property names. -->
<!-- FIXME: SC043 Remove running of "edge" tests. -->
        <!-- FIXME: SC043 Remove reporting of edge coverage from the artifacts page.  -->

<project name="boost" default="all" basedir=".">
    <property name="label" value="build-dev"/>

    <property name="build.dir" location="build"/>
    <property name="config.dir" location="config"/>
    <property name="lib.dir" location="lib"/>
    <property name="src.dir" location="src"/>
    <property name="classes.dir" location="${build.dir}/classes"/>
    <property name="coverage.dir" location="${build.dir}/coverage"/>
    <property name="instrumented.dir" location="${coverage.dir}/instrumented"/>
    <property name="artifacts.dir" location="${build.dir}/artifacts"/>
    <property name="reports.dir" location="${artifacts.dir}/reports"/>
    <property name="coverage.reports.dir" location="${reports.dir}/coverage"/>
    <property name="jars.dir" location="${artifacts.dir}/jars"/>
    <property name="test.report.dir" location="${reports.dir}/test"/>
    <property name="test.xml.report.dir" location="${test.report.dir}/xml"/>
    <property name="checkstyle.config.dir" location="${config.dir}/checkstyle"/>
    <property name="checkstyle.report.dir" location="${reports.dir}/checkstyle"/>
    <property name="checkstyle.dir" location="${build.dir}/checkstyle"/>
    <property name="simian.config.dir" location="${config.dir}/simian"/>


     <property name="simian.report.dir" location="${reports.dir}/simian"/>
    <property name="build.config.dir" location="${config.dir}/build"/>
    <property name="edge.src.dir" location="${src.dir}/edge/java"/>
    <property name="core.src.dir" location="${src.dir}/core/java"/>
    <property name="test.src.dir" location="${src.dir}/test/java"/>
    <property name="edge.class.dir" location="${classes.dir}/edge"/>
    <property name="core.class.dir" location="${classes.dir}/core"/>
    <property name="test.class.dir" location="${classes.dir}/test"/>
    <property name="core.instrumented.dir" location="${instrumented.dir}/core"/>
    <property name="test.instrumented.dir" location="${instrumented.dir}/test"/>

    <fileset id="atomic.tests" dir="${test.src.dir}">
        <include name="**/*AtomicTest.java"/>
    </fileset>

    <!-- FIXME: SC043 Remove. -->
    <!-- FIXME: SC043 Do we need to remove anything from the artifacts page. -->

    <patternset id="code.pattern">
        <include name="**/*.java"/>
    </patternset>

    <fileset id="checkstyle.core.code" dir="${core.src.dir}">
        <patternset refid="code.pattern"/>
    </fileset>

    <fileset id="checkstyle.edge.code" dir="${edge.src.dir}">
        <patternset refid="code.pattern"/>
    </fileset>

    <fileset id="checkstyle.test.code" dir="${test.src.dir}">
        <patternset refid="code.pattern"/>
    </fileset>

    <fileset id="simian.boost.code" dir="${src.dir}">
        <patternset refid="code.pattern"/>
        <exclude name="**/pair/*.java"/>
        <!-- FIXME: SC502 Remove duplication and then remove these exclusions. -->
        <!-- NO MORE WAIVERS/EXCLUSIONS HERE.  FIX FIRST!!!!  EVEN THOUGH SOME ARE SIMIAN FALSE POSITIVES -->
        <exclude name="**/StartTime.java"/>
        <exclude name="**/EndTime.java"/>
        <exclude name="**/DefaultEdgeReflect.java"/>
        <exclude name="**/DefaultEdgeInputStream.java"/>
        <exclude name="**/DefaultEdgeOutputStream.java"/>
        <exclude name="**/MockListener.java"/>
        <!-- FIXME: SC502 This was put in here due to duplication detected between test code and production code ... which is allowed? -->
    </fileset>

    <fileset id="simian.boo.code" dir="${src.dir}">
        <include name="**/pair/boo/**/*.java"/>
    </fileset>

    <fileset id="simian.monster.code" dir="${src.dir}">
        <include name="**/pair/monster/**/*.java"/>
    </fileset>

    <fileset id="simian.rah.code" dir="${src.dir}">
        <include name="**/pair/rah/**/*.java"/>
    </fileset>

    <fileset id="simian.scream.code" dir="${src.dir}">
        <include name="**/pair/scream/**/*.java"/>
    </fileset>

    <path id="core.coverage.classpath">
        <path location="${edge.class.dir}"/>
        <path location="${core.instrumented.dir}"/>
        <path location="${core.class.dir}"/>
        <path location="${test.class.dir}"/>
        <path refid="cobertura.classpath"/>
    </path>

    <path id="edge.classpath"/>

    <path id="core.classpath">
        <path location="${edge.class.dir}"/>
    </path>

    <path id="test.classpath">
        <path refid="core.classpath"/>
        <path location="${core.class.dir}"/>
        <path refid="junit.classpath"/>
    </path>

    <!-- FIXME: SC502 Create a jar patternset to remove duplication of includes here. -->
    <path id="cobertura.classpath">
        <fileset dir="${lib.dir}/cobertura">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="checkstyle.class.path">
        <fileset dir="${lib.dir}/checkstyle">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="junit.classpath">
        <fileset dir="${lib.dir}/junit">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="simian.class.path">
        <fileset dir="${lib.dir}/simian">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <target name="all" depends="clean,artifacts,compile,instrument,run,report,check,build_jar"/>

    <target name="run" depends="run_tests,run_checkstyle,run_simian"/>
    <target name="report" depends="report_tests,report_coverage"/>
    <target name="check" depends="check_tests,check_coverage,check_checkstyle,check_simian"/>

    <target name="compile">
        <macro_javac srcdir="${edge.src.dir}" destdir="${edge.class.dir}" classpathref="edge.classpath"/>
        <macro_javac srcdir="${core.src.dir}" destdir="${core.class.dir}" classpathref="core.classpath"/>
        <macro_javac srcdir="${test.src.dir}" destdir="${test.class.dir}" classpathref="test.classpath"/>
    </target>

    <macrodef name="macro_javac">
        <attribute name="srcdir"/>
        <attribute name="destdir"/>
        <attribute name="classpathref"/>
        <sequential>
            <mkdir dir="@{destdir}"/>
            <javac srcdir="@{srcdir}" destdir="@{destdir}" classpathref="@{classpathref}" debug="true"/>
        </sequential>
    </macrodef>

    <target name="clean">
        <delete dir="${build.dir}"/>
    </target>

    <!-- FIXME: SC502 API jar which contains just Primordial? -->
    <target name="build_jar">
        <!-- FIXME: SC502 boost-run.jar which contains ONLY edge/core. -->
        <mkdir dir="${jars.dir}"/>
        <jar jarfile="${jars.dir}/boost.jar">
            <fileset dir="${core.class.dir}" includes="**"/>
            <fileset dir="${edge.class.dir}" includes="**"/>
            <fileset dir="${test.class.dir}" includes="**"/>
            <fileset dir="${core.src.dir}" includes="**"/>
            <fileset dir="${edge.src.dir}" includes="**"/>
            <fileset dir="${test.src.dir}" includes="**"/>
        </jar>
    </target>

    <target name="artifacts">
        <copy file="${build.config.dir}/artifacts.html" tofile="${artifacts.dir}/index.html">
            <filterset>
                <filter token="BUILD_LABEL" value="${label}"/>
            </filterset>
        </copy>
    </target>

    <target name="run_tests">
        <macro_junit_run tests.refid="atomic.tests" classpath.refid="core.coverage.classpath" coverage.type="core"
                         failure.property="atomic.tests.failed"/>
    </target>

    <target name="report_tests">
        <macro_junit_report/>
    </target>

    <target name="check_tests">
        <!-- FIXME: SC502 junit.@{code.type}.failed. -->
        <macro_junit_check failure.property="atomic.tests.failed"/>
        <macro_junit_check failure.property="edge.tests.failed"/>
    </target>

    <macrodef name="macro_junit_run">
        <attribute name="tests.refid"/>
        <attribute name="classpath.refid"/>
        <attribute name="coverage.type"/>
        <attribute name="failure.property"/>
        <sequential>
            <mkdir dir="${test.xml.report.dir}"/>
            <junit fork="true" forkmode="perBatch" showoutput="true" printSummary="true" haltonfailure="false"
                   failureproperty="@{failure.property}">
                <!-- FIXME: SC502 Parameterise the coverage file for different test styles. -->
                <sysproperty key="net.sourceforge.cobertura.datafile"
                             file="${coverage.dir}/@{coverage.type}_coverage.ser"/>
                <classpath refid="@{classpath.refid}"/>
                <formatter type="xml"/>
                <formatter type="plain"/>
                <batchtest todir="${test.xml.report.dir}">
                    <fileset refid="@{tests.refid}"/>
                </batchtest>
            </junit>
        </sequential>
    </macrodef>

    <macrodef name="macro_junit_report">
        <sequential>
            <junitreport todir="${test.report.dir}" tofile="TestReport.xml">
                <!-- FIXME: SC502 Move fileset out.  -->
                <fileset dir="${test.xml.report.dir}">
                    <include name="TEST-*.xml"/>
                </fileset>
                <report format="frames" todir="${test.report.dir}"/>
            </junitreport>
        </sequential>
    </macrodef>

    <macrodef name="macro_junit_check">
        <attribute name="failure.property"/>
        <sequential>
            <!-- FIXME: SC502 Use code.type instead? Does this match the model? -->
            <fail if="@{failure.property}" message="One or more tests failed [@{failure.property}]."/>
        </sequential>
    </macrodef>

    <target name="instrument">
        <macro_cobertura_instrument code.type="core"/>
    </target>

    <target name="report_coverage">
        <macro_cobertura_report code.type="core" report.type="atomic"/>
    </target>

    <target name="check_coverage">
        <macro_cobertura_check code.type="core" branch.limit="100" line.limit="100"/>
        <!-- Approach "du jour" is to not run coverage on "edge".  -->
    </target>

    <!-- FIXME: SC502 Move from top level into a target depended on by others. -->
    <taskdef resource="tasks.properties" classpathref="cobertura.classpath"/>

    <macrodef name="macro_cobertura_instrument">
        <attribute name="code.type"/>
        <sequential>
            <mkdir dir="${instrumented.dir}/@{code.type}"/>
            <cobertura-instrument todir="${instrumented.dir}/@{code.type}"
                                  datafile="${coverage.dir}/@{code.type}_coverage.ser">
                <fileset dir="${classes.dir}/@{code.type}">
                    <include name="**/*.class"/>
                    <exclude name="**/Xxx*.class"/>
                </fileset>
            </cobertura-instrument>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_report">
        <attribute name="code.type"/>
        <attribute name="report.type"/>
        <sequential>
            <mkdir dir="${coverage.reports.dir}/@{code.type}/@{report.type}"/>
            <cobertura-report destdir="${coverage.reports.dir}/@{code.type}/@{report.type}"
                              datafile="${coverage.dir}/@{code.type}_coverage.ser">
                <!-- FIXME: SC502 Parameterise -->
                <fileset dir="${core.src.dir}" includes="**/*.java"/>
            </cobertura-report>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_check">
        <attribute name="branch.limit"/>
        <attribute name="line.limit"/>
        <attribute name="code.type"/>
        <sequential>
            <!-- FIXME: SC502 Don't halt on failure. Follow with a <fail> task with a message consistent with other failures. -->
            <cobertura-check totalbranchrate="@{branch.limit}" totallinerate="@{line.limit}"
                             failureproperty="coverage.@{code.type}.failed" haltonfailure="true"
                             datafile="${coverage.dir}/@{code.type}_coverage.ser"/>
        </sequential>
    </macrodef>

    <target name="quality" depends="run_checkstyle,run_simian,check_checkstyle,check_simian"/>

    <target name="checkstyle" depends="run_checkstyle,check_checkstyle"/>

    <!-- FIXME: SC502 merge run/check checkstyle targets into parameterised macro. -->
    <target name="run_checkstyle">
        <macro_run_checkstyle code.type="core"/>
        <macro_run_checkstyle code.type="edge"/>
        <macro_run_checkstyle code.type="test"/>
    </target>

    <target name="check_checkstyle">
        <macro_check_checkstyle code.type="core"/>
        <macro_check_checkstyle code.type="edge"/>
        <macro_check_checkstyle code.type="test"/>
    </target>

    <!-- FIXME: SC502 Consider whether we need to keep separate rules for core/edge/test. -->
    <!-- FIXME: SC502 Review and revise checkstyle rules. -->
    <!-- FIXME: SC502 Fix all code to adhere to checkstyle rules - see suppressions. -->
    <!-- FIXME: SC502 Tighten suppressions so that checks are still done for kickstart pair code. -->
    <macrodef name="macro_run_checkstyle">
        <attribute name="code.type"/>
        <sequential>
            <mkdir dir="${checkstyle.dir}"/>
            <mkdir dir="${checkstyle.report.dir}"/>
            <taskdef resource="checkstyletask.properties" classpathref="checkstyle.class.path"/>
            <checkstyle config="${checkstyle.config.dir}/checkstyle-@{code.type}.xml"
                        failOnViolation="false" failureProperty="checkstyle.@{code.type}.failed">
                <formatter/>
                <formatter type="xml" tofile="${checkstyle.report.dir}/checkstyle-@{code.type}.xml"/>
                <fileset refid="checkstyle.@{code.type}.code"/>
            </checkstyle>
            <style in="${checkstyle.report.dir}/checkstyle-@{code.type}.xml"
                   out="${checkstyle.report.dir}/checkstyle-@{code.type}.html"
                   style="${checkstyle.config.dir}/checkstyle-noframes-sorted.xsl"/>
        </sequential>
    </macrodef>

    <macrodef name="macro_check_checkstyle">
        <attribute name="code.type"/>
        <sequential>
            <fail if="checkstyle.@{code.type}.failed" message="Checkstyle failure [@{code.type}]."/>
        </sequential>
    </macrodef>

    <target name="simian" depends="run_simian,check_simian"/>

    <target name="run_simian">
        <macro_run_simian code.type="boost"/>
        <macro_run_simian code.type="boo"/>
        <macro_run_simian code.type="monster"/>
        <macro_run_simian code.type="rah"/>
        <macro_run_simian code.type="scream"/>
    </target>

    <target name="check_simian">
        <macro_check_simian code.type="boost"/>
        <macro_check_simian code.type="boo"/>
        <macro_check_simian code.type="monster"/>
        <macro_check_simian code.type="rah"/>
        <macro_check_simian code.type="scream"/>
    </target>

    <!-- FIXME: SC502 Remove remaining duplication reports by Simian - see exclusions in fileset. -->
    <macrodef name="macro_run_simian">
        <attribute name="code.type"/>
        <sequential>
            <mkdir dir="${simian.report.dir}"/>
            <taskdef resource="simiantask.properties" classpathref="simian.class.path"/>
            <!-- FIXME: SC502 Experiment with ignore options to strengthen check. -->
            <simian threshold="4" language="java" balanceParentheses="true" balanceSquareBrackets="true"
                    failureProperty="simian.@{code.type}.failed">
                <fileset refid="simian.@{code.type}.code"/>
                <formatter type="xml" tofile="${simian.report.dir}/simian-@{code.type}.xml"/>
                <formatter type="plain"/>
            </simian>
            <style in="${simian.report.dir}/simian-@{code.type}.xml" out="${simian.report.dir}/simian-@{code.type}.html"
                   style="${simian.config.dir}/simian.xsl"/>
        </sequential>
    </macrodef>

    <macrodef name="macro_check_simian">
        <attribute name="code.type"/>
        <sequential>
            <fail if="simian.@{code.type}.failed" message="Simian detected duplication [@{code.type}]."/>
        </sequential>
    </macrodef>

</project>
