<?xml version="1.0" encoding="UTF-8"?>
<project name="boost" default="ignore" basedir=".">

    <target name="instrument">
        <macro_cobertura_instrument code.type="core"/>
    </target>

    <target name="report_coverage">
        <macro_cobertura_report code.type="core" report.type="atomic"/>
    </target>

    <target name="check_coverage">
        <macro_cobertura_check code.type="core" branch.limit="100" line.limit="100"/>
        <!-- Approach "du jour" is to not run coverage on "edge".  -->
    </target>

    <taskdef resource="tasks.properties" classpathref="cobertura.classpath"/>

    <macrodef name="macro_cobertura_instrument">
        <attribute name="code.type"/>
        <sequential>
            <mkdir dir="${instrumented.dir}/@{code.type}"/>
            <cobertura-instrument todir="${instrumented.dir}/@{code.type}"
                                  datafile="${coverage.dir}/@{code.type}_coverage.ser">
                <fileset dir="${classes.dir}/@{code.type}">
                    <include name="**/*.class"/>
                    <exclude name="**/Xxx*.class"/>
                </fileset>
            </cobertura-instrument>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_report">
        <attribute name="code.type"/>
        <attribute name="report.type"/>
        <sequential>
            <mkdir dir="${coverage.reports.dir}/@{code.type}/@{report.type}"/>
            <cobertura-report destdir="${coverage.reports.dir}/@{code.type}/@{report.type}"
                              datafile="${coverage.dir}/@{code.type}_coverage.ser">
                <!-- FIXME: SC502 Parameterise -->
                <fileset dir="${core.src.dir}" includes="**/*.java"/>
            </cobertura-report>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_check">
        <attribute name="branch.limit"/>
        <attribute name="line.limit"/>
        <attribute name="code.type"/>
        <sequential>
            <!-- FIXME: SC502 Don't halt on failure. Follow with a <fail> task with a message consistent with other failures. -->
            <cobertura-check totalbranchrate="@{branch.limit}" totallinerate="@{line.limit}"
                             failureproperty="coverage.@{code.type}.failed" haltonfailure="true"
                             datafile="${coverage.dir}/@{code.type}_coverage.ser"/>
        </sequential>
    </macrodef>

    <import file="build-init.xml"/>
</project>