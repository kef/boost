<?xml version="1.0" encoding="UTF-8"?>
<project name="boost-cobertura" default="ignore" basedir=".">
    <import file="build-init.xml"/>

    <property name="quality.atomic.coverage.branch" value="100"/>
    <property name="quality.atomic.coverage.line" value="100"/>

    <target name="instrument_cobertura">
        <macro_cobertura_instrument code.type="core" test.type="atomic"/>
    </target>

    <target name="report_cobertura">
        <macro_cobertura_report code.type="core" test.type="atomic"/>
    </target>

    <target name="check_cobertura">
        <macro_cobertura_check code.type="core" test.type="atomic"
                               branch.limit="${quality.atomic.coverage.branch}"
                               line.limit="${quality.atomic.coverage.line}"/>
    </target>

    <taskdef resource="tasks.properties" classpathref="cobertura.classpath"/>

    <macrodef name="macro_cobertura_instrument">
        <attribute name="code.type"/>
        <attribute name="test.type"/>
        <sequential>
            <cobertura-instrument todir="${cobertura.class.dir}"
                                  datafile="${cobertura.dir}/@{test.type}_coverage.ser">
                <fileset dir="${classes.dir}/@{code.type}">
                    <include name="**/*.class"/>
                    <exclude name="**/Xxx*.class"/>
                    <exclude name="**/nursery/**"/>
                </fileset>
            </cobertura-instrument>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_report">
        <attribute name="code.type"/>
        <attribute name="test.type"/>
        <sequential>
            <mkdir dir="${cobertura.reports.dir}/@{code.type}/@{test.type}"/>
            <cobertura-report destdir="${cobertura.reports.dir}/@{code.type}/@{test.type}"
                              datafile="${cobertura.dir}/@{test.type}_coverage.ser">
                <fileset dir="${@{code.type}.src.dir}" includes="**/*.java"/>
            </cobertura-report>
        </sequential>
    </macrodef>

    <macrodef name="macro_cobertura_check">
        <attribute name="branch.limit"/>
        <attribute name="line.limit"/>
        <attribute name="code.type"/>
        <attribute name="test.type"/>
        <sequential>
            <cobertura-check totalbranchrate="@{branch.limit}" totallinerate="@{line.limit}"
                             failureproperty="coverage.@{code.type}.failed" haltonfailure="true"
                             datafile="${cobertura.dir}/@{test.type}_coverage.ser"/>
        </sequential>
    </macrodef>
</project>